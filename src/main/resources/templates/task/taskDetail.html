<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{./include/layout_admin :: setContent(~{:: .taskDetails})}">

<div class="taskDetails">
	
	<style>
	
	/* 공통사항 */
	.taskDtlContainer {
		
		
	}
	
	.taskDtlBox {
	  width: 800px;
	  height: 800px;
	  text-align: center;
	  
	  box-shadow: 0 2px 3px #999;
	  margin: 30px auto;
	  
	  
	}

	.taskDtlRow {
	  border-top: 1px solid rgb(227, 227, 227);
	  border-collapse: collapse;
	  margin-bottom: 20px;
	  line-height: 20px;
	  height: 60px;
	}
	
	.taskDtlRow:first-child {
		border-top: none;
	}
	
	.taskDtlHeads, .tastDtlBodies {
	  padding: 10px;
	  text-align: center;
	  font-size: large;
	  font-weight: bold;
	  
	}
	
	.toggleBtnBox {
	  padding: 10px;
	  text-align: center;
	  font-size: large;
	  font-weight: bold;
	}
	
	.taskDtlBodiesS {
	  padding: 10px;
	  text-align: center;
	  font-size: large;
	  font-weight: bold;
	  overflow: hidden;
	}

	
	.taskDtlDates {
	  padding: 10px;
	  text-align: left;
	}
	
	
	.taskDtlTable {
	  width: 700px;
	  height: 700px;
	  line-height: 300px;
	  padding: 20px;
	  
	  margin: 30px auto 10px;
	}
	
	
	.colspanInput {
	  width: 98%;
	  block-size: 30px;
	}
	
	.taskDtlInput {
	  width: 95%;
	  block-size: 30px;
	}
	
	.taskDtlInputL {
		width: 98%;
		block-size: 30px;
	}
	
	.taskDtlInputR {
		width:65%;
		block-size: 30px;
		float: left;
	}
	
	.datetimepicker {
	  width: 150px;
	  text-align: left;
	}
	
	.DtlBtnBox {
	  margin: 0 auto;
	  text-align: center;
	  
	}
	
	#toListBtn {
	  width: 80px;
	  height: 40px;
	  background-color: #020f37;
      color: #fff;
      font-weight: bold;
	}
	
	#commentSaveBtn {
	  width: 80px;
	  height: 40px;
	  background-color: #020f37;
      color: #fff;
      font-weight: bold;
	}
	
	.taskDtlBodiesS > .taskDtlBtn {
	    background-color: #020f37;
	    color: #fff;
	   	width: 70px;
	   	height: 30px;
	   	font-weight: bold;
	   	float: right;
	   	font-size: 15px;
  	}
  	
  	.projectSelectBox {
		  width: 300px;
	  }
	  
	#startDateTime {
		block-size: 30px;
		margin-left: 10px;
		margin-right: 30px;
	}
	
	#endDateTime {
		block-size: 30px;
		margin-left: 10px;
	}
	
	.textInput {
		width: 550px;
		height: 200px;
		border: 1px solid #777;
		resize: none;
	}
	
	#taskDetailStatus {
		width: 100px;
		text-align: center;
		border-radius: 20px;
		color: #fff;
		font-weight: bold;
	
	}
	
	#enginnerBtn {
		width: 100px;
		text-align: center;
		border-radius: 20px;
		color: #fff;
		font-weight: bold;
		font-size: 16px;
		background-color: rgb(72, 175, 148);
	}
	
	.taskStartToggleBtn {
	  width: 80px;
	  height: 40px;
	  background-color: #020f37;
      color: #fff;
      font-weight: bold;
      font-size: 16px;
	}
	
	.taskEndToggleBtn {
	  width: 80px;
	  height: 40px;
	  background-color: #020f37;
      color: #fff;
      font-weight: bold;
      font-size: 16px;
	}
	
	</style>	
	
	<body>
	  <div class="taskDtlContainer">
	    
      <h3>작업 상세</h3>
      <form name="actionForm" action="commentRegForm" method="post">		  
	    <div class="taskDtlBox">
			  
		      <table class="taskDtlTable">
				  <input type="hidden" name="task_id" id="hiddenTaskId" th:value="${taskVO.task_id}">
				  <input type="hidden" name="pjt_id" id="hiddenPjtId" th:value="${taskVO.pjt_id}">
				  <input type="hidden" name="server_id" id="hiddenserverId" th:value="${taskVO.server_id}">
				  <input type="hidden" name="user_id" id="hiddenUserId" th:value="${taskVO.user_id}">
				  <tr class="taskDtlRow">
					  <th class="taskDtlHeads">프로젝트명</th>
					  <td class="taskDtlBodies" name="pjt_nm">[[${taskVO.pjt_nm}]]</td> <!--프로젝트이름-->
						  <td class="taskDtlBodies detailStatus" name="status_id" th:if="${taskVO.status_id == 1}">
							  <input type="button" id="taskDetailStatus" name="status_dtl" th:value="${taskVO.status_dtl}" style="background-color: blue;" readonly>
						  </td> <!--작업상태표시 1-->
						  <td class="taskDtlBodies detailStatus" name="status_id" th:if="${taskVO.status_id == 2}">
							  <input type="button" id="taskDetailStatus" name="status_dtl" th:value="${taskVO.status_dtl}" style="background-color: green;" readonly>
						  </td> <!--작업상태표시-->
						  <td class="taskDtlBodies detailStatus" name="status_id" th:if="${taskVO.status_id == 3}">
							  <input type="button" id="taskDetailStatus" name="status_dtl" th:value="${taskVO.status_dtl}" style="background-color: gray;" readonly>
						  </td> <!--작업상태표시-->
						  <td class="taskDtlBodies detailStatus" name="status_id" th:if="${taskVO.status_id == 4}">
							  <input type="button" id="taskDetailStatus" name="status_dtl" th:value="${taskVO.status_dtl}" style="background-color: orange;" readonly>
						  </td> <!--작업상태표시-->
						  <td class="taskDtlBodies detailStatus" name="status_id" th:if="${taskVO.status_id == 5}">
							  <input type="button" id="taskDetailStatus" name="status_dtl" th:value="${taskVO.status_dtl}" style="background-color: red;" readonly>
						  </td> <!--작업상태표시-->
						  
						  
						  <td class="toggleBtnBox" name="time_check_yn" th:if="${taskVO.time_check_yn == 0}">
				  	  		  <input type="button" class="taskStartToggleBtn" value="시작">
				  		  </td> <!--시작버튼-->
				  		  <td class="toggleBtnBox" name="time_check_yn" th:if="${taskVO.time_check_yn == 1}">
				  	  		  <input type="button" class="taskEndToggleBtn" value="종료">
				  		  </td> <!--종료버튼-->
				  		  <td class="toggleBtnBox" name="time_check_yn" th:if="${taskVO.time_check_yn == 2}">
				  	  		  
				  		  </td> <!--종료버튼-->
						  
					  
				  </tr>
				  		  
		          <tr class="taskDtlRow">
		            <th class="taskDtlHeads">고객사</th>
		            <td class="taskDtlBodies" name="user_group">[[${taskVO.user_group}]]</td> <!--고객사 이름-->
		          	<th class="taskDtlHeads">담당자</th>
		            <td class="taskDtlBodiesS">
						<input type="button" id="enginnerBtn" name="user_nm" th:value="${taskVO.user_nm}" readonly>
					</td> <!--담당자이름표시-->
				  </tr>
		          
		          <tr class="taskDtlRow">
		            <th class="taskDtlHeads">작업일</th>
		            <td class="taskDtlDates">
						[[${taskVO.task_date}]]
						</td>
		            <th class="taskDtlHeads">작업시간</th>
		            <td class="taskDtlDates">
						[[${taskVO.task_st_dt}]] ~ [[${taskVO.task_end_dt}]]
					</td>
		          </tr>
		  
		  		  
		          <tr class="taskDtlRow">
		            <th class="taskDtlHeads">작업장소</th>
		            <td colspan="3" name="user_adr" class="taskDtlBodies">[[${taskVO.user_adr}]]</td> <!--작업장소-->
		          </tr>
		  
		          <tr class="taskDtlRow">
		            <th class="taskDtlHeads">작업명</th>
		            <td colspan="3" name="task_nm" class="taskDtlBodies">[[${taskVO.task_nm}]]</td> <!--작업명-->
		          </tr>
		  
		          <tr class="taskDtlRow">
		            <th class="taskDtlHeads">작업내용</th>
		            <td colspan="3" name="task_dtl" class="taskDtlBodies">[[${taskVO.task_dtl}]]</td> <!--작업내용-->
		          </tr>
		          
		          <tr class="taskDtlRow" name="user_role" th:if="${session.user_role == 'ROLE_ENGINEER' or session.user_role == 'ROLE_ADMIN'}">
					  <th class="taskDtlHeads">작업결과</th>
					  <td colspan="3" class="taskDtlBodies"><textarea class="textInput" id="comment_dtl" name="comment_dtl" placeholder="작업결과를 입력해주세요">[[${taskVO.comment_dtl}]]</textarea></td>
				  </tr>
				  
				  
		    </table>
				  
				  

		    <!-- 버튼 기능 -->
		    <div class="DtlBtnBox">
				<input type="button" id="commentSaveBtn" value="결과저장">
		      	<input type="button" id="toListBtn" onclick="location.href='/task/taskList'" value="목록">
		    </div>
		</div>
		
	
	  </form>
	
	  </div>
	  
	  	<!--datetimePicker-->
	<script>
		
		//시작일시
		//const startDateTimeInput = document.querySelector(".startDateTime");
		//종료일시
		//const endDateTimeInput = document.querySelector(".endDateTime");
		
		//작업일
		//let task_dateInput = document.querySelector(".taskDateTime");
		
		//현재일시
		//function getCurrentDateTime() {
            //const now = new Date();
            //const year = now.getFullYear();
            //const month = String(now.getMonth() + 1).padStart(2, "0");
            //const day = String(now.getDate()).padStart(2, "0");
            //const hours = String(now.getHours()).padStart(2, "0");
            //const minutes = String(now.getMinutes()).padStart(2, "0");

            //return `${year}-${month}-${day}T${hours}:${minutes}`;
        //}
		
		//시작일시 입력 필드의 최소값과 기본값 설정
		//const currentDateTime = getCurrentDateTime();
        //task_dateInput.min = task_dateInput;
        //task_dateInput.value = task_dateInput;
		
		//종료일시 입력 필드의 최소값 설정
		//startDateTimeInput.addEventListener("change", function () {
            //endDateTimeInput.min = startDateTimeInput.value;
        //});
        
        
        	
	</script>
	
	<script>
		
        //작업시작 클릭 이벤트(시간 저장)
		$(".taskStartToggleBtn").click(function(e){			
			e.preventDefault();
			let target = e.target;
			console.log(target);
			
			let taskValue = $(this).val(); //시작버튼의 값
			
			//$(this).addClass("taskEndToggleBtn").attr("value", "종료");
			
			//실제 시작시간 값			
        	let now = new Date();
        	let year = now.getFullYear();
        	let month = String(now.getMonth() + 1).padStart(2, "0");
        	let day = String(now.getDate()).padStart(2, "0");
        	let hours = String(now.getHours()).padStart(2, "0");
        	let minutes = String(now.getMinutes()).padStart(2, "0");

        	let taskStartTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        	
        	
			let task_id = $("#hiddenTaskId").val();
			let pjt_id = $("#hiddenPjtId").val();
			let server_id = $("#hiddenserverId").val();
			
			$.ajax({
				url: "../checkStartTaskTime",
				type: "post",
				contentType: "application/json",
				data: JSON.stringify({
					"r_st_dt": taskStartTime,
					"task_id": task_id}),
				success: function(data) {
					console.log(data);
					alert("작업시간 체크!");
					
					str ='';
					str += '<input type="button" class="taskEndToggleBtn" value="종료">';
					
					str2 ='';
					str2 += '<input type="button" id="taskDetailStatus" name="status_dtl" value="작업중" style="background-color: green;" readonly>';
					
					$(".toggleBtnBox").html(str);
					$(".detailStatus").html(str2);
					
				},
				error: function(status, error) {
					console.log(status);
					console.log(error);
					alert("시간 체크 실패!")
				}
			})
		})
		
		
		//작업종료 클릭 이벤트(시간 저장)
		$(".taskEndToggleBtn").click(function(e){			
			e.preventDefault();
			let target = e.target;
			console.log(target);
			
			let taskValue = $(this).val(); //시작버튼의 값
			
			//$(this).addClass("taskEndToggleBtn").attr("value", "종료");
			
			//실제 시작시간 값			
        	let now = new Date();
        	let year = now.getFullYear();
        	let month = String(now.getMonth() + 1).padStart(2, "0");
        	let day = String(now.getDate()).padStart(2, "0");
        	let hours = String(now.getHours()).padStart(2, "0");
        	let minutes = String(now.getMinutes()).padStart(2, "0");

        	let taskEndTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        	
        	
			let task_id = $("#hiddenTaskId").val();
			let pjt_id = $("#hiddenPjtId").val();
			let server_id = $("#hiddenserverId").val();
			
			$.ajax({
				url: "../checkEndTaskTime",
				type: "post",
				contentType: "application/json",
				data: JSON.stringify({
					"r_end_dt": taskEndTime,
					"task_id": task_id}),
				success: function(data) {
					console.log(data);
					alert("작업종료 체크!");
					
					str ='';
					
					str2 ='';
					str2 += '<input type="button" id="taskDetailStatus" name="status_dtl" value="작업완료" style="background-color: gray;" readonly>';
					
					$(".toggleBtnBox").html(str);
					$(".detailStatus").html(str2);
					
				},
				error: function(status, error) {
					console.log(status);
					console.log(error);
					alert("시간 체크 실패!")
				}
			})
		})
		
		
		//작업결과 저장
		let commentSaveBtn = document.getElementById("commentSaveBtn");
		
		commentSaveBtn.addEventListener("click", function(e) {
			
			e.preventDefault();
			document.actionForm.submit();
			
		})
		
		
		
	</script>
	  
	  
	  
	  
</div>	
	
</div>